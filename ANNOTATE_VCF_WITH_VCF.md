

The following sections describe how to use **qpipeline** to annotate a VCF file with a VCF database file.

## Create and index VCF database file 

The instructions provided here can be used to create any VCF database files.  For simplicity, a partial VCF file from NCBI called _common_all_20161122.vcf_ is provided in _${QPIPELINE_HOME}/test_data/vcf_ directory.  This file contained only small number of entries from chromsome 1 downloaded from ftp://ftp.ncbi.nlm.nih.gov/snp/organisms/human_9606/VCF/common_all_20161122.vcf.gz

NOTE: Both the input VCF file and the VCF database file must have the same chromosome format. 
That is, either '1',..., '22', 'X', 'Y', 'M' or 'chr1',..., 'chr22', 'chrX', 'chrY', 'chrM'.  Check to make sure your input VCF file and your VCF database file have the same format before indexing your VCF database file.

The sample input VCF file ( _${QPIPELINE_HOME}/test_data/vcf/sample.vcf_ ) uses 'chr1',...,'chr22', 'chrX', 'chrY','chrM' so we will add the prefix 'chr' to _common_all_20161122.vcf_ before indexing it.

Change into directory _${QPIPELINE_HOME}/test_data/vcf_  

```
cd ${QPIPELINE_HOME}/test_data/vcf
```

To create a tabix database file for _common_all_20161122.vcf_, do the following

```
# set FILE variable to "common_all_20161122.vcf" so we can cut, paste, and use the commands below
FILE="common_all_20161122.vcf"

# get just the VCF header then add 'chr' to all entries
cat $FILE | grep ^# >  ${FILE}.modified.vcf
cat $FILE | grep -v ^# | awk '{ print "chr"$0 }' >> ${FILE}.modified.vcf


# bgzip the newly created file ( bgzip is part of tabix )
bgzip  ${FILE}.modified.vcf


# Index the zipped file using tabix
# An index file with extension .tbi is generated by tabix
# Once done, ${FILE}.modified.gz can be used as the VCF database for qpipeline
tabix -p vcf  ${FILE}.modified.vcf.gz 
```


## Annotate input VCF file against VCF database file

Annotate _sample.vcf_ with the _common_all_20161122.vcf.modified.vcf.gz_ database and direct output to _sample.common_all.vcf_
```
qpipeline tabix -m 2020  -i sample.vcf -d common_all_20161122.vcf.modified.vcf.gz -q COMMON_ALL > sample.COMMON_ALL.vcf 
```
where ( see ${QPIPELINE_HOME}/qpipeline tabix -m 2020 for full usage info )
* -i input VCF file 
* -d bgziped and tabix indexed VCF database file 
* -q VCF database identifer.  For example, COMMON_ALL.

In the annotation command above, the input VCF file is _sample.vcf_, the bgzipped and tabix indexed VCF database is _common_all_20161122.vcf.modified.vcf.gz_, the VCF database identifier is _COMMON_ALL_ and the rediected output file is _sample.COMMON_ALL.vcf_.

If an entry in the input file is matched with one or more entries in the database file ( based on chromosome, position, reference and variant alleles ) then the annotation added to the VCF INFO column looks like as follows:

```
...;IDENTIFER=n,M,MATCHING_DECRIPTIONS,DATA;...
```
where 

* IDENTIFIER is the VCF database identifer entered by the user and n is either 0 (no matches from the VCF database ) or 1 ( there is at least one matched from the VCF database)
* M is the number of matches from the VCF database.   These matches have the same chromosomes, positions, the reference and alternative alleles.
* MATCHING_DECRIPTIONS are the descriptions of the matching record.
* DATA is the data entry from the database.

